{% extends "research/detail_base.html" %}
{% load i18n object_lock links_for_work %}

{% block heading %}
{% if object.antiquarian_set.count %}
<div class='mb-2'>
    <small>
        {% for a in object.antiquarian_set.all %}{% if not forloop.first %}, {% endif %}<a href='{{ a.get_absolute_url }}'>{{ a }}</a>{% endfor %}
    </small>
</div>
{% endif %}
<div>{{ object.name }}</div>
{% endblock %}

{% block last_modified %}{% endblock %}

{% block action %}

    {% with request.user|has_lock:object as has_object_lock %}

        {% include 'research/partials/render_locked_info.html' %}

        <div class='d-flex justify-content-end'>
        {% if has_object_lock %}
            {% if perms.research.delete_work %}
                <form novalidate class='form-inline' action='{% url "work:delete" work.pk %}' method='POST'>
                    {% csrf_token %}
                    <div class='form-group'>
                        <button type='submit' class='btn btn-link text-danger confirm-delete p-0 ml-2'
                            data-what='work'>{% trans 'Delete' %}</button>
                    </div>
                </form>
            {% endif %}
        {% endif %}
        </div>
    {% endwith %}
{% endblock %}

{% block inner %}
    {% with request.user|has_lock:object as has_object_lock %}
    <hr>
    <section>
        <div class='d-flex justify-content-between mb-3'>
            <div>
                <h5>{% trans 'Details' %}</h5>
            </div>
            <div>
                {% if perms.research.change_work and has_object_lock %}
                <a href='{% url "work:update" object.pk %}'>{% trans 'Edit' %}</a>
                {% endif %}
            </div>
        </div>

        <dl class="row mb-0">
            <dt class="col-sm-3">{% trans 'Name of Work' %}</dt>
            <dd class="col-sm-9">{{ object.name }}</dd>

            <dt class="col-sm-3">{% trans 'Subtitle' %}</dt>
            <dd class="col-sm-9">{{ object.subtitle|default:'-' }}</dd>

            <dt class="col-sm-3">{% trans 'Relevant Dates' %}</dt>
            <dd class="col-sm-9">
                {{ object.display_date_range|default:'-' }}
            </dd>

            <dt class="col-sm-3">{% trans 'Number of Books' %}</dt>
            <dd class="col-sm-7">{{ object.number_of_books|default:'-' }}</dd>
            {% if perms.research.change_work and perms.research.add_book and has_object_lock %}
            <dd class="col-sm-2 actions"><a style='float:right' href='{% url "work:create_book" object.pk %}'>Add Book</a></dd>
            {% endif %}

            {% if object.book_set.count > 0 %}

            <dt class="col-sm-3">{% trans 'Books' %}</dt>
            <dd class="col-sm-9">

            {% for book in object.book_set.all %}
                <div class='d-flex justify-content-between mb-3'>
                    <div>{{ book }}<br><small>{{ book.display_date_range }}</small></div>
                    <div>
                        <form novalidate class='form-inline' action='{% url "work:delete_book" book.pk %}' method='POST'>
                            {% csrf_token %}
                            <div class='form-row align-items-center'>
                                {% if perms.research.change_work and perms.research.change_book and has_object_lock %}
                                <a href='{% url "work:update_book" book.pk %}'>Edit</a>
                                {% endif %}
                                {% if perms.research.change_work and perms.research.delete_book and has_object_lock %}
                                <button type='submit' class='btn btn-link text-danger confirm-delete p-0 ml-2'
                                    data-what='book'>{% trans 'Delete' %}</button>
                                {% endif %}
                                <a class='ml-2' href='{{ book.history_url }}'><small><i class='fas fa-list'></i> Changelog</small></a>
                            </div>
                        </form>
                    </div>
                </div>
            {% endfor %}
            </dd>

            {% endif %}
        </dl>

        <p>
            <small>
            {% include 'research/partials/render_last_modified_info.html' with object=object %}
            </small>
        </p>

    </section>

    {% comment %}
    <hr>
    <section>
        <div class='d-flex justify-content-between mb-3'>
            <div>
                <h5>{% trans 'Antiquarians' %}</h5>
            </div>
        </div>

        {% for antiquarian in object.antiquarian_set.all %}

        {% include 'research/partials/antiquarian_list_item.html' %}

        {% endfor %}
    </section>

    {% endcomment %}

    <hr>

    <section>
      <div class='d-flex justify-content-between mb-3'>
        <div>
          <h5>{% trans 'Books' %}</h5>
        </div>
      </div>
      {% for book, material in ordered_materials.items %}
        <h5>{{ book }}</h5>
          {% if material.fragments %}
            {% if material.fragments.definite %}
              <h7>{% trans 'Definite Fragments' %}</h7>
              {% for fragment in material.fragments.definite %}
                {% include 'research/partials/fragment_list_item.html' with fragment=fragment %}
              {% endfor %}
            {% endif %}
            {% if material.fragments.possible %}
              <h7>{% trans 'Possible Fragments' %}</h7>
              {% for fragment in material.fragments.possible %}
                {% include 'research/partials/fragment_list_item.html' with fragment=fragment %}
              {% endfor %}
            {% endif %}
          {% endif %}
          {% if material.testimonia %}
            {% if material.testimonia.definite %}
              <h7>{% trans 'Definite Testimonia' %}</h7>
              {% for testimonium in material.testimonia.definite %}
                {% include 'research/partials/testimonium_list_item.html' with testimonium=testimonium %}
              {% endfor %}
            {% endif %}
            {% if material.testimonia.possible %}
              <h7>{% trans 'Possible Testimonia' %}</h7>
              {% for testimonium in material.testimonia.possible %}
                {% include 'research/partials/testimonium_list_item.html' with testimonium=testimonium %}
              {% endfor %}
            {% endif %}
          {% endif %}
          {% if material.apposita %}
            {% if material.apposita.definite %}
              <h7>{% trans 'Definite Apposita' %}</h7>
              {% for appositum in material.apposita.definite %}
                {% include 'research/partials/fragment_list_item.html' with fragment=appositum %}
              {% endfor %}
            {% endif %}
            {% if material.apposita.possible %}
              <h7>{% trans 'Possible Apposita' %}</h7>
              {% for appositum in material.apposita.possible %}
                {% include 'research/partials/fragment_list_item.html' with fragment=appositum %}
              {% endfor %}
            {% endif %}
          {% endif %}
      {% endfor %}
    </section>

    <hr>

    <section>
        <div class='d-flex justify-content-between mb-3'>
            <div>
                <h5>{% trans 'Definite Testimonia' %}</h5>
            </div>
            <div>
            </div>
        </div>

        {% for testimonium in object.definite_testimonia.all %}

        {% include 'research/partials/testimonium_list_item.html' with testimonium=testimonium %}

        {% endfor %}
    </section>

    <hr>

    <section>
        <div class='d-flex justify-content-between mb-3'>
            <div>
                <h5>{% trans 'Possible Testimonia' %}</h5>
            </div>
            <div>
            </div>
        </div>

        {% for testimonium in object.possible_testimonia.all %}

        {% include 'research/partials/testimonium_list_item.html' with testimonium=testimonium %}

        {% endfor %}
    </section>

    <hr>

    <section>
        <div class='d-flex justify-content-between mb-3'>
            <div>
                <h5>{% trans 'Definite Fragments' %}</h5>
            </div>
            <div>
            </div>
        </div>

        {% for fragment in object.definite_fragments.all %}

        {% include 'research/partials/fragment_list_item.html' with fragment=fragment %}

        {% endfor %}
    </section>

    <hr>

    <section>
        <div class='d-flex justify-content-between mb-3'>
            <div>
                <h5>{% trans 'Possible Fragments' %}</h5>
            </div>
            <div>
            </div>
        </div>

        {% for fragment in object.possible_fragments.all %}

        {% include 'research/partials/fragment_list_item.html' with fragment=fragment %}

        {% endfor %}
    </section>


    <hr>

    <section>
        <div class='d-flex justify-content-between mb-3'>
            <div>
                <h5>{% trans 'Apposita' %}</h5>
            </div>
            <div>
                {% if perms.research.change_work and has_object_lock %}
                <a href='{% url "anonymous_fragment:create_appositum_for" "work" object.pk %}'>{% trans 'Create Appositum' %}</a>
                {% endif %}
            </div>
        </div>


            {% with alinks=object.antiquarian_work_appositumfragmentlinks.all %}


                {% for link in alinks %}
                    {% include 'research/partials/appositum_fragment_link_list_item.html' with link=link link_text=link.get_work_display_name_full|safe can_edit=False %}
                {% endfor %}

                {% if not alinks %}
                <div class='text-muted my-3 ml-4'><em>No linked material for this work</em></div>
                {% endif %}

            {% endwith %}

    </section>


    {% comment %}
        <hr>


    <section>
        <div class='d-flex justify-content-between mb-3'>
            <div>
                <h5>{% trans 'Ordered Material' %}</h5>
            </div>
            <div>
            </div>
        </div>

        <ul>
            <div class='ordered-list'>
            {% with tlinks=object.antiquarian_work_testimoniumlinks.all %}
            {% with flinks=object.antiquarian_work_fragmentlinks.all %}
            {% with alinks=object.antiquarian_work_appositumfragmentlinks.all %}

                {% for link in tlinks %}
                    {% include 'research/partials/testimonium_link_list_item.html' with link=link link_text=link.get_work_display_name_full|safe can_edit=perms.research.change_work has_object_lock=has_object_lock %}
                {% endfor %}

                {% for link in flinks %}
                    {% include 'research/partials/fragment_link_list_item.html' with link=link  link_text=link.get_work_display_name_full|safe can_edit=perms.research.change_work has_object_lock=has_object_lock %}
                {% endfor %}

                {% for link in alinks %}
                    {% include 'research/partials/appositum_fragment_link_list_item.html' with link=link link_text=link.get_work_display_name_full|safe can_edit=perms.research.change_work has_object_lock=has_object_lock %}
                {% endfor %}

                {% if not flinks and not tlinks and not alinks %}
                <div class='text-muted my-3 ml-4'><em>No linked material for this work</em></div>
                {% endif %}

            {% endwith %}
            {% endwith %}
            {% endwith %}
            </div>
        </ul>




    </section>

    {% endcomment %}

    {% endwith %}
{% endblock %}
